name: Build MapCache on Windows
on: [ push ]

jobs:

    build-matrix:
      strategy:
        matrix:
          os: [ windows-2019 ]
          option: [ default ]
      runs-on: ${{ matrix.os }}
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Install dependencies
          run: |
            Set-Location -Path ${{ github.workspace }}
            New-Item -Path . -Name "sdk" -ItemType "directory"
            Set-Location -Path "sdk"
            curl -O https://download.gisinternals.com/sdk/downloads/release-1928-x64-dev.zip
            unzip -qq release-1928-x64-dev.zip

        - name: Build MapCache
          run: |
            Set-Location -Path ${{ github.workspace }}
            New-Item -Path . -Name "build" -ItemType "directory"
            Set-Location -Path "build"
            $sdkprefix = "${{ github.workspace }}\sdk\release-1928-x64"
            Copy-Item -Path "$sdkprefix\lib\libfcgi.lib" -Destination "$sdkprefix\lib\fcgi.lib"
            Copy-Item -Path "$sdkprefix\lib\apr-1.lib" -Destination "$sdkprefix\lib\apr-1-1.lib"
            Copy-Item -Path "$sdkprefix\lib\libapr-1.lib" -Destination "$sdkprefix\lib\apr-1.lib"
            Copy-Item -Path "$sdkprefix\lib\aprutil-1.lib" -Destination "$sdkprefix\lib\aprutil-1-1.lib"
            Copy-Item -Path "$sdkprefix\lib\libaprutil-1.lib" -Destination "$sdkprefix\lib\aprutil-1.lib"
            cmake -DCMAKE_PREFIX_PATH="$sdkprefix" -DWITH_APACHE=OFF -DWITH_FCGI=ON -DWITH_PCRE=ON ${{ github.workspace }}
            cmake --build . --config Release
            Copy-Item -Path ..\mapcache.xml -Destination .
            Copy-Item -Path Release\mapcache.dll -Destination .
            Copy-Item -Path cgi\Release\mapcache.fcgi.exe -Destination .
            Copy-Item -Path util\Release\mapcache_seed.exe -Destination .
            Copy-Item -Path contrib\mapcache_detail\Release\mapcache_detail.exe -Destination .
            Compress-Archive -DestinationPath mapcache.zip -Path mapcache.xml, mapcache.dll, mapcache.fcgi.exe, mapcache_seed.exe, mapcache_detail.exe
            Get-ChildItem

          - name: Run tests
            run: |
              $env.MAPCACHE_CONFIG_FILE = "mapcache.xml"
              $env.PATH_INFO = "/"
              $env.REQUEST_METHOD = "GET"
              $env.QUERY_STRING = "SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&STYLES=&FORMAT=image/png&SRS=EPSG:4326&BBOX=0,0,10,10&WIDTH=256&HEIGHT=256&LAYERS=test&TRANSPARENT=TRUE"
              mapcache.fcgi.exe
              mapcache_seed.exe -h

